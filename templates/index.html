<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PriceScout Shopping Search</title>
    <style>
      :root {
        --ink: #0f172a;
        --muted: #64748b;
        --brand: #2563eb;
        --bg: #f8fafc;
        --card: #ffffff;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: Inter, system-ui, sans-serif;
        color: var(--ink);
        background: linear-gradient(180deg, #f8fafc 0%, #eff6ff 100%);
      }
      main { max-width: 1120px; margin: 0 auto; padding: 28px; display: grid; gap: 18px; }
      .panel { background: var(--card); border-radius: 14px; padding: 20px; border: 1px solid #e2e8f0; }
      h1, h2 { margin: 0; }
      .subtitle { color: var(--muted); margin-top: 8px; }
      .controls { display: flex; gap: 10px; margin-top: 14px; flex-wrap: wrap; }
      input, button {
        font: inherit;
        padding: 11px 12px;
        border-radius: 10px;
        border: 1px solid #cbd5e1;
      }
      #searchInput { flex: 1; min-width: 280px; }
      button { background: var(--brand); color: white; border: none; cursor: pointer; }
      .hint { font-size: 12px; color: var(--muted); margin-top: 10px; }
      table { width: 100%; border-collapse: collapse; margin-top: 10px; }
      th, td {
        text-align: left;
        padding: 10px 8px;
        border-bottom: 1px solid #e2e8f0;
        font-size: 14px;
        vertical-align: top;
      }
      .mono { font-family: ui-monospace, Menlo, monospace; font-size: 12px; color: var(--muted); }
      .price { font-weight: 700; color: #0f766e; }
      .score { font-weight: 600; color: #1d4ed8; }
      a { color: #1d4ed8; text-decoration: none; }
      a:hover { text-decoration: underline; }
    </style>
  </head>
  <body>
    <main>
      <section class="panel">
        <h1>PriceScout Shopping Search</h1>
        <p class="subtitle">Search any parts, accessories, tools, or other inventory items your store needs. Results are ranked from lowest to highest price and filtered for relevant wording matches.</p>
        <div class="controls">
          <input id="searchInput" placeholder="Try: iphone 12 charging port flex cable" />
          <button id="searchButton">Search</button>
        </div>
        <p class="hint">Tip: Include brand, model, size, or part details for the most relevant results.</p>
      </section>

      <section class="panel">
        <h2>Results</h2>
        <p id="resultMeta" class="mono">Enter a query to begin.</p>
        <table>
          <thead>
            <tr>
              <th>Item</th>
              <th>Source</th>
              <th>Price</th>
              <th>Match</th>
              <th>Link</th>
            </tr>
          </thead>
          <tbody id="resultRows"></tbody>
        </table>
      </section>
    </main>

    <script>
      function formatPrice(value) {
        const parsed = Number(value);
        if (Number.isFinite(parsed)) return `$${parsed.toFixed(2)}`;
        return value || 'N/A';
      }

      function resultRow(item) {
        const link = item.link ? `<a href="${item.link}" target="_blank" rel="noopener noreferrer">View item</a>` : '<span class="mono">N/A</span>';
        return `
          <tr>
            <td><strong>${item.title || 'Untitled item'}</strong></td>
            <td>${item.source || 'Unknown'}</td>
            <td class="price">${formatPrice(item.price_value ?? item.price)}</td>
            <td class="score">${Math.round((item.match_score || 0) * 100)}%</td>
            <td>${link}</td>
          </tr>
        `;
      }

      async function runSearch() {
        const query = document.getElementById('searchInput').value.trim();
        if (!query) {
          alert('Please enter a search query.');
          return;
        }

        const rows = document.getElementById('resultRows');
        const meta = document.getElementById('resultMeta');
        rows.innerHTML = '';
        meta.textContent = 'Searchingâ€¦';

        try {
          const res = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
          const data = await res.json();
          if (!res.ok) {
            throw new Error(data.error || 'Search failed');
          }

          rows.innerHTML = data.results.map(resultRow).join('');
          meta.textContent = `Found ${data.count} item(s) for "${data.query}".`;

          if (!data.results.length) {
            rows.innerHTML = '<tr><td colspan="5" class="mono">No matching products found. Try adding more specific details (brand, model, size, color, etc.).</td></tr>';
          }
        } catch (err) {
          rows.innerHTML = '<tr><td colspan="5" class="mono">Search failed.</td></tr>';
          meta.textContent = err.message;
        }
      }

      document.getElementById('searchButton').addEventListener('click', runSearch);
      document.getElementById('searchInput').addEventListener('keydown', (event) => {
        if (event.key === 'Enter') runSearch();
      });
    </script>
  </body>
</html>
