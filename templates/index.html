<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Google Review Command Center</title>
    <style>
      :root {
        --ink: #0f172a;
        --muted: #64748b;
        --brand: #2563eb;
        --bg: #f8fafc;
        --card: #ffffff;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: Inter, system-ui, sans-serif;
        color: var(--ink);
        background: var(--bg);
      }
      main { max-width: 1100px; margin: 0 auto; padding: 24px; display: grid; gap: 20px; }
      .panel { background: var(--card); border-radius: 14px; padding: 18px; border: 1px solid #e2e8f0; }
      h1,h2 { margin: 0; }
      .subtitle { color: var(--muted); margin-top: 6px; }
      .stats { display:grid; grid-template-columns: repeat(auto-fit,minmax(170px,1fr)); gap: 12px; }
      .stat { background:#eff6ff; padding:12px; border-radius:10px; }
      .label { font-size: 12px; color: var(--muted); text-transform: uppercase; }
      .value { font-size: 22px; font-weight: 700; }
      table { width:100%; border-collapse: collapse; }
      th, td { text-align: left; padding: 10px 8px; border-bottom: 1px solid #e2e8f0; font-size: 14px; vertical-align: top; }
      .controls { display:flex; gap:10px; flex-wrap: wrap; margin-top: 12px; }
      select, textarea, input, button {
        font: inherit;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #cbd5e1;
      }
      button { background: var(--brand); color: #fff; border: none; cursor: pointer; }
      button.secondary { background: #334155; }
      textarea { width:100%; min-height: 90px; }
      .badge { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; }
      .pending { background:#fef3c7; color:#92400e; }
      .responded { background:#dcfce7; color:#166534; }
      .mono { font-family: ui-monospace, Menlo, monospace; font-size: 12px; color: var(--muted); }
    </style>
  </head>
  <body>
    <main>
      <section class="panel">
        <h1>Google Review Management</h1>
        <p class="subtitle">BirdEye-style operations for multi-storefront monitoring and auto-replies.</p>
        <div class="stats" id="stats"></div>
      </section>

      <section class="panel">
        <h2>Storefronts</h2>
        <div class="controls">
          <select id="storefrontFilter"></select>
          <select id="statusFilter">
            <option value="all">All statuses</option>
            <option value="pending">Pending</option>
            <option value="responded">Responded</option>
          </select>
          <button id="refreshReviews">Refresh reviews</button>
        </div>
        <p class="mono">Tip: Create auto-response templates with placeholders like {{reviewer_name}}, {{storefront_name}}, {{rating}}, {{comment}}</p>
      </section>

      <section class="panel">
        <h2>Auto-response rules</h2>
        <div class="controls">
          <input id="minRating" type="number" value="4" min="1" max="5" />
          <input id="maxRating" type="number" value="5" min="1" max="5" />
          <button id="saveRule">Save rule for selected storefront</button>
        </div>
        <textarea id="ruleTemplate">Thanks {{reviewer_name}} for your {{rating}}-star review at {{storefront_name}}. We appreciate your support!</textarea>
      </section>

      <section class="panel">
        <h2>Recent reviews</h2>
        <table>
          <thead>
            <tr>
              <th>Storefront</th>
              <th>Rating</th>
              <th>Review</th>
              <th>Status</th>
              <th>Response</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="reviewRows"></tbody>
        </table>
      </section>
    </main>

    <script>
      const state = { storefronts: [], reviews: [] };

      async function jsonFetch(url, options) {
        const res = await fetch(url, options);
        if (!res.ok) throw new Error(await res.text());
        return await res.json();
      }

      function selectedStorefrontId() {
        const value = document.getElementById('storefrontFilter').value;
        return value === 'all' ? null : Number(value);
      }

      function renderStats(data) {
        const cards = [
          ['Total Reviews', data.total_reviews ?? 0],
          ['Pending', data.pending_reviews ?? 0],
          ['Responded', data.responded_reviews ?? 0],
          ['Avg Rating', data.average_rating ?? '-']
        ];
        document.getElementById('stats').innerHTML = cards
          .map(([label, value]) => `<div class="stat"><div class="label">${label}</div><div class="value">${value}</div></div>`)
          .join('');
      }

      function renderStorefrontFilter() {
        const select = document.getElementById('storefrontFilter');
        const options = ['<option value="all">All storefronts</option>']
          .concat(state.storefronts.map(s => `<option value="${s.id}">${s.name} (${s.city || 'N/A'})</option>`));
        select.innerHTML = options.join('');
      }

      function reviewRow(review) {
        const response = review.response_text ? review.response_text : '<span class="mono">No response yet</span>';
        return `
          <tr>
            <td>${review.storefront_name}</td>
            <td>${'‚≠ê'.repeat(review.rating)} (${review.rating})</td>
            <td><strong>${review.reviewer_name}</strong><br/>${review.comment}</td>
            <td><span class="badge ${review.status}">${review.status}</span></td>
            <td>${response}</td>
            <td>
              <button class="secondary" onclick="respond(${review.id})" ${review.status === 'responded' ? 'disabled' : ''}>Auto-respond</button>
            </td>
          </tr>
        `;
      }

      function renderReviews() {
        document.getElementById('reviewRows').innerHTML = state.reviews.map(reviewRow).join('');
      }

      async function loadOverview() {
        renderStats(await jsonFetch('/api/overview'));
      }

      async function loadStorefronts() {
        state.storefronts = await jsonFetch('/api/storefronts');
        renderStorefrontFilter();
      }

      async function loadReviews() {
        const storefrontId = selectedStorefrontId();
        const status = document.getElementById('statusFilter').value;
        const params = new URLSearchParams();
        if (storefrontId) params.set('storefront_id', storefrontId);
        if (status !== 'all') params.set('status', status);
        state.reviews = await jsonFetch(`/api/reviews?${params.toString()}`);
        renderReviews();
      }

      async function respond(reviewId) {
        try {
          await jsonFetch(`/api/reviews/${reviewId}/respond`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
          });
          await Promise.all([loadOverview(), loadReviews()]);
        } catch (err) {
          alert('Failed to respond: ' + err.message);
        }
      }

      async function saveRule() {
        const storefrontId = selectedStorefrontId();
        if (!storefrontId) {
          alert('Please choose a specific storefront before saving a rule.');
          return;
        }
        const payload = {
          storefront_id: storefrontId,
          min_rating: Number(document.getElementById('minRating').value),
          max_rating: Number(document.getElementById('maxRating').value),
          template: document.getElementById('ruleTemplate').value
        };

        try {
          await jsonFetch('/api/auto-rules', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          alert('Rule saved. New auto-responses will use this template.');
        } catch (err) {
          alert('Failed to save rule: ' + err.message);
        }
      }

      document.getElementById('refreshReviews').addEventListener('click', loadReviews);
      document.getElementById('statusFilter').addEventListener('change', loadReviews);
      document.getElementById('storefrontFilter').addEventListener('change', loadReviews);
      document.getElementById('saveRule').addEventListener('click', saveRule);

      Promise.all([loadOverview(), loadStorefronts()]).then(loadReviews);
      window.respond = respond;
    </script>
  </body>
</html>
